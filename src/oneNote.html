<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<script src="https://how2j.cn/study/js/jquery/2.0.0/jquery.min.js"></script>
<link href="https://how2j.cn/study/css/bootstrap/3.3.6/bootstrap.min.css" rel="stylesheet">
<script src="https://how2j.cn/study/js/bootstrap/3.3.6/bootstrap.min.js"></script>

<style>
    .onenote {
        /*text-align: center;*/
        width: 80%;
        border: 1px solid #999999;
    }

    .contentDiv {
        text-align: left;
        width: 100%;
        border: 1px solid pink;
        outline: none;
        padding: 15px;
    }

    .codeDiv {
        text-align: left;
    }

    .codeDiv {
        /* width: 500px; */
        /* height: 500px; */
    }

    .titleDiv {
        border: 1px solid #999999;
        height: 100%;
        width: 20%;
    }

    .knowledgeTitle {
        display: block;
        text-align: center;
        font-weight: bold;
        font-size: 20px;
        width: 30%;
        margin: 20px auto 30px;
    }

    .copySpan {
        cursor: pointer;
        z-index: 1;
    }

    .save {
        width: 100px;
    }

    .saveParentDiv {
        text-align: center;
    }

    .exportButton {
        position: absolute;
        top: 10px;
    }

    .importButton {
        position: absolute;
        top: 10px;
        left: 100px;
    }

    .adjustDiv {
        width: 80%;
        margin: 20px auto;
        position: relative;
    }
    .editSpan{
        cursor: pointer;
        font-size: 16px;
        vertical-align: center;
    }

</style>


<div class="onenote pull-left">
    <div class="adjustDiv">
        <button class="exportButton btn btn-info"><span class="	glyphicon glyphicon-export"></span> 导出</button>
        <button class="importButton btn btn-info"><span class="	glyphicon glyphicon-import"></span> 导入</button>
        <input type="text" class="knowledgeTitle form-control">

        <button class="addCodeButton">
            <span class="glyphicon glyphicon-plus" title="添加代码"></span>
        </button>
        <span class="glyphicon glyphicon-file editSpan"></span>
        <button class="save btn btn-success pull-right">保存</button>
        <div style="clear: both"></div>


        <div class="contentDiv" contenteditable="true"></div>
    </div>
</div>


<div class="pull-right titleDiv">
    <div class="list-group listTitle">
        <a href="#" class="list-group-item list-group-item-default addTitleLink"><span
                class="glyphicon glyphicon-plus"></span></a>
    </div>
</div>


<!------------------------------------->
<div>
    <a href="#" aid="xx" class="titleLink list-group-item list-group-item-success">
        <span class="titleInA"></span>
        <span class="glyphicon glyphicon-trash pull-right deleteLink"></span>
    </a>
</div>


<pre class="pre" did="0" contenteditable="true" style="display: none"></pre>

<script>
    $(function () {
        //选中文本
        function selectText(element) {
            var text = document.getElementById(element);
            if (document.body.createTextRange) {
                var range = document.body.createTextRange();
                range.moveToElementText(text);
                range.select();
            } else if (window.getSelection) {
                var selection = window.getSelection();
                var range = document.createRange();
                range.selectNodeContents(text);
                selection.removeAllRanges();
                selection.addRange(range);
                /*if(selection.setBaseAndExtent){
                    selection.setBaseAndExtent(text, 0, text, 1);
                }*/
            } else {
                alert("none");
            }
        }

        $('a.titleLink[aid=xx]').hide()

        //如果titles是空，则创建
        if (localStorage.getItem("titles") == null) {
            localStorage.setItem("titles", "");
        }

        //  得到标题
        function getTitle() {
            var titleList = new Array();
            var titles = localStorage.getItem("titles")
            if (titles.length == 0) {
                return titleList;
            }
            var titleArray = titles.split("|||");
            for (var i in titleArray) {
                if (titleArray[i].trim().length != 0) {
                    titleList.push(titleArray[i]);
                }
            }
            return titleList;
        }

        //保存标题
        function saveTitles(titleList) {
            var titleStr = ""
            for (var i in titleList) {
                titleStr += titleList[i] + "|||"
            }
            localStorage.setItem("titles", titleStr);
        }

        //    复制
        function copy(element) {
            $(element).dblclick(function () {
                var selection = window.getSelection();
                selection.removeAllRanges();
                var range = document.createRange();
                // var parent = $(this).parent()
                range.selectNodeContents($(this)); // 需要选中的dom节点
                selection.addRange(range);
                // $(this).show()
            })
        }


        //刷新标题
        function reFreshTitle() {
            $("a.titleLink[aid!=xx]").remove();
            var titleList = getTitle();
            for (var i in titleList) {
                $("a.titleLink[aid=xx]").clone(true).attr("aid", i).appendTo(".listTitle").click(function () {
                    //    点击标题打开每一个知识点
                    var title = $(this).text().trim();
                    var content = localStorage.getItem(title)
                    $(".knowledgeTitle").val(title)
                    $(".contentDiv").html(content)
                });
                $("a.titleLink[aid=" + i + "] .titleInA").html(titleList[i])
            }
            $("a.titleLink[aid!=xx]").show();


        }

        reFreshTitle()

        //    标题失去焦点保存
        $(".knowledgeTitle").blur(function () {
            var title = $(this).val();

            var found = true;

            var titleList = getTitle();
            for (var i in titleList) {
                if (titleList[i] == title || 0 == title.length) {
                    found = false;
                    break;
                }
            }
            if (found) {
                titleList.push(title)
                saveTitles(titleList)
                reFreshTitle();
            }
        })

        //    添加标题
        $(".addTitleLink").click(function () {
            $(".knowledgeTitle").val("")
            $(".knowledgeTitle").focus()
            $(".contentDiv").html("")
        })

        // 添加代码
        $(".addCodeButton").click(function () {
            var content = $(".contentDiv").html();
            $(".contentDiv").html(content + "<br>" + "<textarea class='inputCodeTA'></textarea>");
            $(".inputCodeTA").focus()
            //保存代码
            $(".inputCodeTA").blur(function () {
                $(".inputCodeTA").hide();
                var content = $(this).val();
                if(content.trim().length === 0){
                    return
                }
                content = html_encode(content);
                console.log(content)

                $("pre[did='0']").clone(true).html(content).attr({
                    "did": "1",
                    "style": "display:block",
                }).appendTo($(".contentDiv"))

                var content1 = $(".contentDiv").html();
                $(".contentDiv").html(content1 + "<br>")

            })
        })


        //    保存
        $(".contentDiv").blur(function () {
            var tit = $(".knowledgeTitle").val();
            if (tit.length == 0) {
                alert("标题不能为空")
                $(".knowledgeTitle").focus()
                return
            }
            var content = $(".contentDiv").html();
            var title = $(".knowledgeTitle").val();
            localStorage.setItem(title, content);
        })
        $(".save").click(function () {
            var tit = $(".knowledgeTitle").val();
            if (tit.length == 0) {
                alert("标题不能为空")
                $(".knowledgeTitle").focus()
                return
            }
            var content = $(".contentDiv").html();
            var title = $(".knowledgeTitle").val();
            localStorage.setItem(title, content);
            $(".contentDiv").html(content + "<br>")
            $(this).html("保存成功")
            setTimeout(function () {
                $(".save").html("保存")
            }, 2000)
        })

        //    初始化数据
        function initData() {
            var titleList = getTitle();
            var startTitle = titleList[titleList.length - 1]
            var startContent = localStorage.getItem(startTitle);

            $(".knowledgeTitle").val(startTitle)
            $(".contentDiv").html(startContent)

            var elem = $("a.titleLink[aid!=xx]");
            if (titleList.length !== 0) {
                elem[elem.length - 1].setAttribute("class", "titleLink list-group-item list-group-item-success");
            }
        }

        initData()

        // 编译和反编译
        function html_encode(str) {
            var s = "";
            if (str.length == 0) return "";
            s = str.replace(/&/g, "&amp;");
            s = s.replace(/</g, "&lt;");
            s = s.replace(/>/g, "&gt;");
            s = s.replace(/ /g, "&nbsp;");
            s = s.replace(/\'/g, "&#39;");
            s = s.replace(/\"/g, "&quot;");
            s = s.replace(/\n/g, "<br/>");
            return s;
        }


        //    给contentDiv添加按键监听
        // $(".contentDiv").keyup(function (e) {
        //     alert(e.keyCode)
        // })

        //    备份文件(导出)
        $("button.exportButton").on("click", function () {

            var textTitles = localStorage.getItem("titles");
            var titleList = getTitle();
            var content = "";
            for (var i in titleList) {
                var textEachContent = localStorage.getItem(titleList[i]);
                content += textEachContent + "||||"
            }
            var textContent = textTitles + "&&&" + "\r\n" + content;
            exportRaw('oneNoteData.txt', textContent)
        })

        function fakeClick(obj) {
            var ev = document.createEvent("MouseEvents");
            ev.initMouseEvent("click", true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
            obj.dispatchEvent(ev);
        }

        function exportRaw(name, data) {
            var urlObject = window.URL || window.webkitURL || window;
            var export_blob = new Blob([data]);
            var save_link = document.createElementNS("http://www.w3.org/1999/xhtml", "a")
            save_link.href = urlObject.createObjectURL(export_blob);
            save_link.download = name;
            fakeClick(save_link);
        }

        //    导入文件
        $(".importButton").click(function () {
            $("#fileInput").click()
        })

    })


    function getFileContent(value) {
        var doc = document.getElementById('fileInput')
        var fileName = doc.files[0].name;
        var selectedFile = doc.files[0];

        var reader = new FileReader();//这里是核心！！！读取操作就是由它完成的。
        reader.readAsText(selectedFile);//读取文件的内容

        reader.onload = function () {
            var content = this.result;
            var titles = content.split("&&&")[0];
            var contents = content.split("&&&")[1];
            var contentList = contents.split("||||");
            var index;
            for (var i in contentList) {
                if (contentList[i].trim().length === 0) {
                    index = i;
                    break;
                }
            }
            if (null != index) {
                contentList.splice(index, 1);
            }
            localStorage.setItem("titles", titles);
            var titleList = titles.split("|||")
            titleList.splice(titleList.length - 1, 1);
            for (var y in titleList) {
                localStorage.setItem(titleList[y], contentList[y])
                location.reload()
            }
        }
    }
</script>

<script>
    //  得到标题
    function getTitle() {
        var titleList = new Array();
        var titles = localStorage.getItem("titles")
        if (titles.length == 0) {
            return titleList;
        }
        var titleArray = titles.split("|||");
        for (var i in titleArray) {
            if (titleArray[i].trim().length != 0) {
                titleList.push(titleArray[i]);
            }
        }
        return titleList;
    }

    //保存标题
    function saveTitles(titleList) {
        var titleStr = ""
        for (var i in titleList) {
            titleStr += titleList[i] + "|||"
        }
        localStorage.setItem("titles", titleStr);
    }

    //删除
    $(".deleteLink").click(function () {
        var log = confirm("是否删除");
        if(log){
            var title = $(this).parent().text();
            title = title.trim();
            var titleList = getTitle();
            titleList = titleList.filter((x) => x !== title);
            saveTitles(titleList)
            $(this).parent().hide();
            //    删除内容
            localStorage.removeItem(title);
            location.reload()
        }
    })

    $(".editSpan").click(function (){
        var contentDivCon = $(".contentDiv").attr("contenteditable");
        var preCon = $("pre").attr("contenteditable");
        if(contentDivCon=="true" && preCon == "true"){
            $(".contentDiv").attr("contenteditable" ,"false")
            $("pre").attr("contenteditable" ,"false")
        }else {
            $(".contentDiv").attr("contenteditable" ,"true")
            $("pre").attr("contenteditable" ,"true")
        }
    })

    $(".contentDiv").keyup(function (e){
        // alert(e.keyCode);

    })


</script>

<input type="file" class="hidden" id="fileInput" onchange="getFileContent(value)">

</body>
</html>